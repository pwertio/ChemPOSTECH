<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>2025-2í•™ê¸° í•™ìƒì¸ê±´ë¹„ í™•ì•½ì„œ/ì„ìš©ì‹ ì²­ì„œ ìƒì„± ì‹œìŠ¤í…œ</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
        }

        h1 {
            text-align: center;
            color: #2d3748;
            margin-bottom: 30px;
            font-size: 2.5rem;
            background: linear-gradient(135deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .step-indicator {
            display: flex;
            justify-content: center;
            margin-bottom: 30px;
        }

        .step {
            display: flex;
            align-items: center;
            margin: 0 20px;
        }

        .step-number {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: #e2e8f0;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            margin-right: 10px;
            transition: all 0.3s ease;
        }

        .step.active .step-number {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
        }

        .step.completed .step-number {
            background: #48bb78;
            color: white;
        }

        .section {
            background: white;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 25px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }

        .section-header {
            background: linear-gradient(135deg, #4a5568, #2d3748);
            color: white;
            padding: 15px 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        .form-group label {
            font-weight: 600;
            color: #2d3748;
            margin-bottom: 8px;
            font-size: 0.95rem;
        }

        .form-group input,
        .form-group select {
            padding: 12px 16px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 1rem;
            transition: all 0.3s ease;
        }

        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 1rem;
            margin: 0 5px;
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
        }

        .btn-primary:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.3);
        }

        .btn-secondary {
            background: #f7fafc;
            color: #4a5568;
            border: 2px solid #e2e8f0;
        }

        .btn-secondary:hover {
            background: #edf2f7;
        }

        .btn-success {
            background: linear-gradient(135deg, #48bb78, #38a169);
            color: white;
        }

        .btn-success:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(72, 187, 120, 0.3);
        }

        .btn-warning {
            background: linear-gradient(135deg, #ed8936, #dd6b20);
            color: white;
        }

        .btn-warning:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(237, 137, 54, 0.3);
        }

        .file-upload {
            border: 2px dashed #cbd5e0;
            border-radius: 12px;
            padding: 40px 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            background: #f7fafc;
            margin-bottom: 20px;
        }

        .file-upload:hover {
            border-color: #667eea;
            background: #edf2f7;
        }

        .file-upload.dragover {
            border-color: #667eea;
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.1), rgba(118, 75, 162, 0.1));
        }

        .file-upload.completed {
            border-color: #48bb78;
            background: #f0fff4;
        }

        .preview-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1);
        }

        .preview-table th,
        .preview-table td {
            padding: 12px 16px;
            text-align: left;
            border-bottom: 1px solid #e2e8f0;
        }

        .preview-table th {
            background: linear-gradient(135deg, #f7fafc, #edf2f7);
            font-weight: 600;
            color: #2d3748;
        }

        .preview-table tr:hover {
            background: #f7fafc;
        }

        .alert {
            padding: 15px 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            border-left: 4px solid;
        }

        .alert-info {
            background: #e6fffa;
            border-color: #38b2ac;
            color: #234e52;
        }

        .alert-success {
            background: #f0fff4;
            border-color: #48bb78;
            color: #276749;
        }

        .alert-warning {
            background: #fffaf0;
            border-color: #ed8936;
            color: #744210;
        }

        .download-section {
            display: none;
            text-align: center;
            padding: 40px;
            background: linear-gradient(135deg, #f0fff4, #e6fffa);
            border-radius: 15px;
            border: 2px solid #48bb78;
        }

        .download-section.show {
            display: block;
        }

        .download-buttons {
            display: flex;
            gap: 20px;
            justify-content: center;
            margin-top: 20px;
        }

        .month-range {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .auto-calculated {
            background: #f0fff4;
            color: #276749;
            font-weight: 600;
            font-style: italic;
        }

        .students-list {
            margin-top: 30px;
        }

        .student-item {
            background: #f8f9fa;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .student-info {
            flex-grow: 1;
        }

        .student-actions button {
            margin-left: 5px;
            padding: 8px 12px;
            font-size: 0.9rem;
        }

        .generate-section {
            display: none;
            text-align: center;
            padding: 30px;
            background: linear-gradient(135deg, #edf2f7, #e2e8f0);
            border-radius: 15px;
            border: 2px solid #667eea;
            margin-top: 30px;
        }

        .generate-section.show {
            display: block;
        }

        .currency-format {
            text-align: right;
        }

        .form-group textarea {
            resize: vertical;
            min-height: 80px;
            font-family: inherit;
        }

        .upload-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-bottom: 30px;
        }

        .upload-item h4 {
            margin-bottom: 15px;
            color: #2d3748;
        }

        .upload-status {
            display: flex;
            align-items: center;
            margin-top: 10px;
        }

        .upload-status.success {
            color: #48bb78;
        }

        .upload-status.error {
            color: #e53e3e;
        }

        .setup-section {
            margin-bottom: 30px;
        }

        .system-settings {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .system-settings h4 {
            margin-bottom: 15px;
            color: #2d3748;
        }

        .update-notice {
            background: linear-gradient(135deg, #fff3cd, #ffeaa7);
            border: 2px solid #ffc107;
            border-radius: 15px;
            padding: 20px;
            margin: 20px 0;
            position: relative;
        }

        .update-notice::before {
            content: "âš ï¸";
            font-size: 24px;
            position: absolute;
            top: 15px;
            left: 20px;
        }

        .update-notice-content {
            margin-left: 40px;
        }

        .update-notice h4 {
            color: #856404;
            margin-bottom: 10px;
            font-weight: bold;
        }

        .update-notice p {
            color: #856404;
            line-height: 1.6;
            margin-bottom: 8px;
        }

        .update-notice .highlight {
            background: #fff3cd;
            padding: 2px 6px;
            border-radius: 4px;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ“ 2025-2í•™ê¸° í•™ìƒì¸ê±´ë¹„ í™•ì•½ì„œ/ì„ìš©ì‹ ì²­ì„œ ìƒì„± ì‹œìŠ¤í…œ</h1>
        
        <!-- ë°°í¬ ì •ë³´ ë° ë¬¸ì˜ì²˜ -->
        <div style="text-align: center; margin-bottom: 20px; background: rgba(255,255,255,0.8); padding: 15px; border-radius: 10px;">
            <p style="margin: 5px 0; color: #4a5568; font-weight: 600;">í¬ìŠ¤í… í™”í•™ê³¼ í–‰ì •íŒ€ ë°°í¬</p>
            <p style="margin: 5px 0; color: #718096; font-size: 0.9rem;">ë¬¸ì˜ì‚¬í•­ ë° ì˜¤ë¥˜ì‹ ê³ ëŠ” í•™ê³¼ í–‰ì •íŒ€ìœ¼ë¡œ ì—°ë½ì£¼ì„¸ìš”</p>
        </div>
        
        <!-- ì—…ë°ì´íŠ¸ ê³µì§€ -->
        <div class="update-notice">
            <div class="update-notice-content">
                <h4>ì¤‘ìš” ì—…ë°ì´íŠ¸ ì•Œë¦¼</h4>
                <p><span class="highlight">ìˆ˜ì •ì‚¬í•­:</span> ë™ì¼í•œ í•™ìƒì´ ê°™ì€ WBS ë²ˆí˜¸ë¡œ ì—¬ëŸ¬ ê¸°ê°„ì— ê±¸ì³ ë‹¤ë¥¸ ê¸ˆì•¡ì„ ì§€ê¸‰ë°›ëŠ” ê²ƒì´ í—ˆìš©ë©ë‹ˆë‹¤.</p>
                <p>ê¸°ì¡´ì˜ <span class="highlight">"ì´ë¯¸ ë“±ë¡ëœ í•™ë²ˆê³¼ WBS ì¡°í•©ì…ë‹ˆë‹¤"</span> ì œí•œì´ ì œê±°ë˜ì—ˆìŠµë‹ˆë‹¤.</p>
                <p>ì˜ˆì‹œ: 'í™ê¸¸ë™' í•™ìƒì´ 9ì›”~11ì›” 60ë§Œì›, 12ì›”~2ì›” 160ë§Œì›ì„ ê°™ì€ WBSì—ì„œ ì§€ê¸‰ë°›ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
            </div>
        </div>
        
        <!-- ë‹¨ê³„ í‘œì‹œê¸° -->
        <div class="step-indicator">
            <div class="step active" id="step1">
                <div class="step-number">1</div>
                <span>ì´ˆê¸° ì„¤ì •</span>
            </div>
            <div class="step" id="step2">
                <div class="step-number">2</div>
                <span>í•™ìƒ ì •ë³´ ì…ë ¥</span>
            </div>
            <div class="step" id="step3">
                <div class="step-number">3</div>
                <span>íŒŒì¼ ìƒì„±</span>
            </div>
        </div>

        <!-- Step 1: ì´ˆê¸° ì„¤ì • -->
        <div class="section" id="setup-section">
            <div class="section-header">
                <h2>âš™ï¸ Step 1: ì´ˆê¸° ì„¤ì •</h2>
                <span>ê¸°ë³¸ ë°ì´í„° ì„¤ì •</span>
            </div>
            
            <!-- ì‹œìŠ¤í…œ ì„¤ì • -->
            <div class="system-settings">
                <h4>ğŸ“… í•™ê¸° ì •ë³´ ì„¤ì •</h4>
                <div class="form-row">
                    <div class="form-group">
                        <label for="academic-year">í•™ë…„ë„ *</label>
                        <input type="text" id="academic-year" required value="2025" placeholder="ì˜ˆ: 2025">
                    </div>
                    <div class="form-group">
                        <label for="semester-code">í•™ê¸°ì½”ë“œ *</label>
                        <input type="text" id="semester-code" required value="0092" placeholder="ì˜ˆ: 0092 (2í•™ê¸°)">
                    </div>
                </div>
            </div>

            <div class="alert alert-info">
                <strong>ğŸ’¡ ì•ˆë‚´:</strong> 
                WBS ë°ì´í„°ì™€ í•™ìƒ ì •ë³´ íŒŒì¼ì„ ì—…ë¡œë“œí•´ì£¼ì„¸ìš”. ê° íŒŒì¼ì˜ í•„ìˆ˜ ì»¬ëŸ¼ì„ í™•ì¸í•˜ì„¸ìš”.
            </div>

            <!-- íŒŒì¼ ì—…ë¡œë“œ ì˜ì—­ -->
            <div class="upload-grid">
                <!-- WBS ë°ì´í„° ì—…ë¡œë“œ -->
                <div class="upload-item">
                    <h4>ğŸ“‹ WBS ë°ì´í„° íŒŒì¼</h4>
                    <div class="alert alert-warning" style="font-size: 0.9rem; padding: 10px;">
                        <strong>í•„ìˆ˜ ì»¬ëŸ¼:</strong> WBSìš”ì†Œ, ê³„ì •ì±…ì„ìNo(ë˜ëŠ” ê³„ì •ì±…ì„ìë²ˆí˜¸), ê³„ì •ì±…ì„ì
                    </div>
                    <div class="file-upload" id="wbs-upload">
                        <div style="font-size: 36px; margin-bottom: 10px;">ğŸ“</div>
                        <h4>WBS ë°ì´í„° ì—…ë¡œë“œ</h4>
                        <p style="color: #718096; margin-top: 5px;">ë“œë˜ê·¸í•˜ê±°ë‚˜ í´ë¦­í•˜ì—¬ ì—…ë¡œë“œ</p>
                        <input type="file" id="wbs-file-input" accept=".xlsx,.xls" style="display: none;">
                    </div>
                    <div class="upload-status" id="wbs-status" style="display: none;">
                        <span id="wbs-status-text"></span>
                    </div>
                </div>

                <!-- í•™ìƒ ë°ì´í„° ì—…ë¡œë“œ -->
                <div class="upload-item">
                    <h4>ğŸ‘¨â€ğŸ“ í•™ìƒ ì •ë³´ íŒŒì¼</h4>
                    <div class="alert alert-warning" style="font-size: 0.9rem; padding: 10px;">
                        <strong>í•„ìˆ˜ ì»¬ëŸ¼:</strong> í•™ë²ˆ, ì´ë¦„, ê³¼ì •, í•™ê¸°, í•™ì ìƒíƒœ, ì§€ê¸‰ê¸°ì¤€, ê¸°ì¤€ê¸ˆì•¡(ì›)
                    </div>
                    <div class="file-upload" id="student-upload">
                        <div style="font-size: 36px; margin-bottom: 10px;">ğŸ‘¥</div>
                        <h4>í•™ìƒ ë°ì´í„° ì—…ë¡œë“œ</h4>
                        <p style="color: #718096; margin-top: 5px;">ë“œë˜ê·¸í•˜ê±°ë‚˜ í´ë¦­í•˜ì—¬ ì—…ë¡œë“œ</p>
                        <input type="file" id="student-file-input" accept=".xlsx,.xls" style="display: none;">
                    </div>
                    <div class="upload-status" id="student-status" style="display: none;">
                        <span id="student-status-text"></span>
                    </div>
                </div>
            </div>

            <!-- ë¯¸ë¦¬ë³´ê¸° ì˜ì—­ -->
            <div id="wbs-preview" style="display: none;">
                <h4 style="margin: 20px 0 10px 0;">ğŸ“Š WBS ë°ì´í„° ë¯¸ë¦¬ë³´ê¸°</h4>
                <table class="preview-table" id="wbs-table">
                    <thead>
                        <tr>
                            <th>WBSìš”ì†Œ</th>
                            <th>ê³„ì •ì±…ì„ìNo</th>
                            <th>ê³„ì •ì±…ì„ì</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>

            <div id="student-preview" style="display: none;">
                <h4 style="margin: 20px 0 10px 0;">ğŸ‘¥ í•™ìƒ ì •ë³´ ë¯¸ë¦¬ë³´ê¸°</h4>
                <table class="preview-table" id="student-table">
                    <thead>
                        <tr>
                            <th>í•™ë²ˆ</th>
                            <th>ì´ë¦„</th>
                            <th>ê³¼ì •</th>
                            <th>í•™ê¸°</th>
                            <th>í•™ì ìƒíƒœ</th>
                            <th>ì§€ê¸‰ê¸°ì¤€</th>
                            <th>ê¸°ì¤€ê¸ˆì•¡(ì›”)</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>

            <div style="text-align: center; margin-top: 30px;">
                <button class="btn btn-primary" onclick="goToStep2()" id="next-step1" disabled>
                    ë‹¤ìŒ ë‹¨ê³„ â†’
                </button>
            </div>
        </div>

        <!-- Step 2: í•™ìƒ ì •ë³´ ì…ë ¥ -->
        <div class="section" id="student-section" style="display: none;">
            <div class="section-header">
                <h2>ğŸ‘¨â€ğŸ“ Step 2: í•™ìƒ ì •ë³´ ì…ë ¥</h2>
                <span>í•™ìƒë³„ ì¡°êµìˆ˜ë‹¹ ì •ë³´ ë“±ë¡</span>
            </div>

            <form id="student-form">
                <div class="form-row">
                    <div class="form-group">
                        <label for="student-id">í•™ë²ˆ *</label>
                        <select id="student-id" required>
                            <option value="">í•™ë²ˆì„ ì„ íƒí•˜ì„¸ìš”</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="student-name">ì´ë¦„</label>
                        <input type="text" id="student-name" class="auto-calculated" readonly placeholder="ìë™ ì…ë ¥">
                    </div>
                    <div class="form-group">
                        <label for="student-position">ê³¼ì •</label>
                        <input type="text" id="student-position" class="auto-calculated" readonly placeholder="ìë™ ì…ë ¥">
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="wbs-element">WBSìš”ì†Œ *</label>
                        <select id="wbs-element" required>
                            <option value="">ì„ íƒí•˜ì„¸ìš”</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="account-no">ê³„ì •ì±…ì„ì ì§ë²ˆ</label>
                        <input type="text" id="account-no" class="auto-calculated" readonly placeholder="ìë™ ì…ë ¥">
                    </div>
                    <div class="form-group">
                        <label for="account-name">ê³„ì •ì±…ì„ì ì´ë¦„</label>
                        <input type="text" id="account-name" class="auto-calculated" readonly placeholder="ìë™ ì…ë ¥">
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="role">ì—­í•  *</label>
                        <textarea id="role" required placeholder="í•´ë‹¹ ê³¼ì œì—ì„œ ì‹¤ì œë¡œ ìˆ˜í–‰í•˜ëŠ” í•™ìƒì˜ ì—…ë¬´ì™€ ê³¼ì œì™€ì˜ ì—°ê´€ì„±ì„ êµ¬ì²´ì ìœ¼ë¡œ ì‘ì„±ë°”ëë‹ˆë‹¤"></textarea>
                    </div>
                    <div class="form-group">
                        <label for="project-category">ê³¼ì œì†Œë¶„ë¥˜ *</label>
                        <select id="project-category" required>
                            <option value="">ì„ íƒí•˜ì„¸ìš”</option>
                            <option value="í•™ìƒì¸ê±´ë¹„(ê°œë³„ê³„ì •)">í•™ìƒì¸ê±´ë¹„(ê°œë³„ê³„ì •)</option>
                            <option value="í•™ìƒì¸ê±´ë¹„(í•™ê³¼ê³„ì •)">í•™ìƒì¸ê±´ë¹„(í•™ê³¼ê³„ì •)</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="monthly-amount">ì›” ì§€ê¸‰ê¸ˆì•¡ *</label>
                        <input type="text" id="monthly-amount" required placeholder="ì˜ˆ: 300,000" class="currency-format">
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label>í™•ì•½ ê¸°ê°„ *</label>
                        <div class="month-range">
                            <select id="start-month" required>
                                <option value="">ì‹œì‘ì›”</option>
                                <option value="9">9ì›”</option>
                                <option value="10">10ì›”</option>
                                <option value="11">11ì›”</option>
                                <option value="12">12ì›”</option>
                                <option value="1">1ì›”</option>
                                <option value="2">2ì›”</option>
                            </select>
                            <span>ë¶€í„°</span>
                            <select id="end-month" required>
                                <option value="">ì¢…ë£Œì›”</option>
                                <option value="9">9ì›”</option>
                                <option value="10">10ì›”</option>
                                <option value="11">11ì›”</option>
                                <option value="12">12ì›”</option>
                                <option value="1">1ì›”</option>
                                <option value="2">2ì›”</option>
                            </select>
                            <span>ê¹Œì§€</span>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="start-date">í™•ì•½ì‹œì‘ì¼</label>
                        <input type="text" id="start-date" class="auto-calculated" readonly placeholder="ìë™ ê³„ì‚°">
                    </div>
                    <div class="form-group">
                        <label for="end-date">í™•ì•½ì¢…ë£Œì¼</label>
                        <input type="text" id="end-date" class="auto-calculated" readonly placeholder="ìë™ ê³„ì‚°">
                    </div>
                </div>
            </form>

            <div style="text-align: center; margin-top: 30px;">
                <button class="btn btn-secondary" onclick="goToStep1()">â† ì´ì „ ë‹¨ê³„</button>
                <button class="btn btn-primary" onclick="addStudent()" id="add-student-btn">
                    ì¶”ê°€ ì…ë ¥
                </button>
                <button class="btn btn-warning" onclick="finishInput()" id="finish-input-btn">
                    ì…ë ¥ ì¢…ë£Œ
                </button>
            </div>

            <!-- ë“±ë¡ëœ í•™ìƒ ëª©ë¡ -->
            <div class="students-list" id="students-list" style="display: none;">
                <h4 style="margin-bottom: 15px;">ğŸ“‹ ë“±ë¡ëœ í•™ìƒ ëª©ë¡</h4>
                <div id="students-container"></div>
            </div>

            <!-- íŒŒì¼ ìƒì„± ì„¹ì…˜ -->
            <div class="generate-section" id="generate-section">
                <h3 style="color: #4a5568; margin-bottom: 20px;">ğŸ“Š íŒŒì¼ ìƒì„± ì¤€ë¹„ ì™„ë£Œ</h3>
                <p style="margin-bottom: 20px;">ì´ <span id="student-count">0</span>ëª…ì˜ í•™ìƒì´ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤.</p>
                <button class="btn btn-success" onclick="generateFiles()" id="generate-files-btn">
                    ì—‘ì…€ íŒŒì¼ ìƒì„±
                </button>
            </div>
        </div>

        <!-- Step 3: íŒŒì¼ ìƒì„± ì™„ë£Œ -->
        <div class="download-section" id="download-section">
            <h2 style="color: #276749; margin-bottom: 20px;">âœ… íŒŒì¼ ìƒì„± ì™„ë£Œ!</h2>
            <p style="font-size: 1.1rem; color: #2d3748; margin-bottom: 30px;">
                ì•„ë˜ ë²„íŠ¼ì„ í´ë¦­í•˜ì—¬ ìƒì„±ëœ ì—‘ì…€ íŒŒì¼ì„ ë‹¤ìš´ë¡œë“œí•˜ì„¸ìš”.
            </p>
            
            <div class="download-buttons">
                <button class="btn btn-success" id="download-salary-btn">
                    ğŸ“‹ í•™ìƒì¸ê±´ë¹„í™•ì•½ì„œ.xlsx ë‹¤ìš´ë¡œë“œ
                </button>
                <button class="btn btn-success" id="download-appointment-btn">
                    ğŸ“„ ëŒ€í•™ì›ìƒì¡°êµì„ìš©ì‹ ì²­ì„œ.xlsx ë‹¤ìš´ë¡œë“œ
                </button>
            </div>

            <div style="margin-top: 30px;">
                <button class="btn btn-primary" onclick="resetAll()">
                    ğŸ”„ ìƒˆë¡œ ì‹œì‘
                </button>
            </div>
        </div>
    </div>

    <script>
        let wbsData = [];
        let studentDatabase = {};
        let systemSettings = {
            academicYear: '2025',
            semester: '0092'
        };
        let registeredStudents = [];

        // ìµœì €ê¸°ì¤€ê¸ˆì•¡
        const minimumSalary = {
            'ì„ì‚¬': 220000,
            'ë°•ì‚¬': 300000,
            'í†µí•©': 300000
        };

        // ì´ˆê¸°í™”
        document.addEventListener('DOMContentLoaded', function() {
            setupFileUploads();
            setupEventListeners();
            updateStepIndicator(1);
        });

        // íŒŒì¼ ì—…ë¡œë“œ ì„¤ì •
        function setupFileUploads() {
            // WBS íŒŒì¼ ì—…ë¡œë“œ
            setupFileUpload('wbs-upload', 'wbs-file-input', handleWBSFile);
            // í•™ìƒ íŒŒì¼ ì—…ë¡œë“œ
            setupFileUpload('student-upload', 'student-file-input', handleStudentFile);
        }

        function setupFileUpload(uploadId, inputId, handler) {
            const uploadArea = document.getElementById(uploadId);
            const fileInput = document.getElementById(inputId);

            uploadArea.addEventListener('click', () => fileInput.click());
            fileInput.addEventListener('change', handler);

            // ë“œë˜ê·¸ ì•¤ ë“œë¡­
            uploadArea.addEventListener('dragover', (e) => {
                e.preventDefault();
                uploadArea.classList.add('dragover');
            });

            uploadArea.addEventListener('dragleave', () => {
                uploadArea.classList.remove('dragover');
            });

            uploadArea.addEventListener('drop', (e) => {
                e.preventDefault();
                uploadArea.classList.remove('dragover');
                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    fileInput.files = files;
                    handler({ target: { files: files } });
                }
            });
        }

        // WBS íŒŒì¼ ì²˜ë¦¬
        function handleWBSFile(event) {
            const file = event.target.files[0];
            if (!file || !validateFile(file)) return;

            showUploadStatus('wbs', 'loading', 'íŒŒì¼ ì½ëŠ” ì¤‘...');

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const firstSheetName = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[firstSheetName];
                    const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
                    
                    processWBSData(jsonData);
                } catch (error) {
                    showUploadStatus('wbs', 'error', 'íŒŒì¼ ì½ê¸° ì‹¤íŒ¨: ' + error.message);
                }
            };
            reader.readAsArrayBuffer(file);
        }

        // í•™ìƒ íŒŒì¼ ì²˜ë¦¬
        function handleStudentFile(event) {
            const file = event.target.files[0];
            if (!file || !validateFile(file)) return;

            showUploadStatus('student', 'loading', 'íŒŒì¼ ì½ëŠ” ì¤‘...');

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const firstSheetName = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[firstSheetName];
                    const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
                    
                    processStudentData(jsonData);
                } catch (error) {
                    showUploadStatus('student', 'error', 'íŒŒì¼ ì½ê¸° ì‹¤íŒ¨: ' + error.message);
                }
            };
            reader.readAsArrayBuffer(file);
        }

        // ì—…ë¡œë“œ ìƒíƒœ í‘œì‹œ
        function showUploadStatus(type, status, message) {
            const statusDiv = document.getElementById(`${type}-status`);
            const statusText = document.getElementById(`${type}-status-text`);
            const uploadDiv = document.getElementById(`${type}-upload`);
            
            statusDiv.style.display = 'flex';
            statusText.textContent = message;
            
            statusDiv.className = 'upload-status';
            if (status === 'success') {
                statusDiv.classList.add('success');
                uploadDiv.classList.add('completed');
                statusText.textContent = 'âœ… ' + message;
            } else if (status === 'error') {
                statusDiv.classList.add('error');
                statusText.textContent = 'âŒ ' + message;
            } else {
                statusText.textContent = 'â³ ' + message;
            }
        }

        // íŒŒì¼ ê²€ì¦
        function validateFile(file) {
            const validTypes = [
                'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet',
                'application/vnd.ms-excel'
            ];
            
            if (!validTypes.includes(file.type)) {
                alert('ì—‘ì…€ íŒŒì¼ë§Œ ì—…ë¡œë“œ ê°€ëŠ¥í•©ë‹ˆë‹¤. (.xlsx, .xls)');
                return false;
            }
            
            if (file.size > 10 * 1024 * 1024) {
                alert('íŒŒì¼ í¬ê¸°ê°€ ë„ˆë¬´ í½ë‹ˆë‹¤. 10MB ì´í•˜ì˜ íŒŒì¼ì„ ì—…ë¡œë“œí•´ì£¼ì„¸ìš”.');
                return false;
            }
            
            return true;
        }

        // WBS ë°ì´í„° ì²˜ë¦¬
        function processWBSData(jsonData) {
            try {
                // í—¤ë” í–‰ ì°¾ê¸°
                let headerRowIndex = -1;
                const requiredColumns = ['WBS', 'ê³„ì •ì±…ì„ì'];
                
                for (let i = 0; i < Math.min(5, jsonData.length); i++) {
                    const row = jsonData[i];
                    if (requiredColumns.every(col => 
                        row.some(cell => cell && cell.toString().includes(col))
                    )) {
                        headerRowIndex = i;
                        break;
                    }
                }
                
                if (headerRowIndex === -1) {
                    showUploadStatus('wbs', 'error', 'WBS ë°ì´í„° í—¤ë”ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                    return;
                }
                
                const headers = jsonData[headerRowIndex];
                const dataRows = jsonData.slice(headerRowIndex + 1);
                
                // ì»¬ëŸ¼ ì¸ë±ìŠ¤ ì°¾ê¸°
                const wbsColIndex = headers.findIndex(h => h && h.toString().includes('WBS'));
                const accountNoColIndex = headers.findIndex(h => 
                    h && h.toString().includes('ê³„ì •ì±…ì„ì') && 
                    (h.toString().includes('No') || h.toString().includes('ë²ˆí˜¸'))
                );
                const accountNameColIndex = headers.findIndex(h => 
                    h && h.toString().includes('ê³„ì •ì±…ì„ì') && 
                    !h.toString().includes('No') && !h.toString().includes('ë²ˆí˜¸')
                );
                
                if (wbsColIndex === -1 || accountNameColIndex === -1) {
                    showUploadStatus('wbs', 'error', 'í•„ìˆ˜ ì»¬ëŸ¼ì´ ì—†ìŠµë‹ˆë‹¤. (WBSìš”ì†Œ, ê³„ì •ì±…ì„ì)');
                    return;
                }
                
                wbsData = dataRows
                    .filter(row => row[wbsColIndex])
                    .map(row => ({
                        element: row[wbsColIndex] ? row[wbsColIndex].toString() : '',
                        accountNo: row[accountNoColIndex] ? row[accountNoColIndex].toString() : '',
                        accountName: row[accountNameColIndex] ? row[accountNameColIndex].toString() : ''
                    }));
                
                if (wbsData.length === 0) {
                    showUploadStatus('wbs', 'error', 'ìœ íš¨í•œ WBS ë°ì´í„°ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                    return;
                }
                
                displayWBSPreview();
                updateWBSDropdown();
                showUploadStatus('wbs', 'success', `${wbsData.length}ê°œ WBS ë°ì´í„° ë¡œë“œ ì™„ë£Œ`);
                checkAllDataLoaded();
                
            } catch (error) {
                showUploadStatus('wbs', 'error', 'WBS ë°ì´í„° ì²˜ë¦¬ ì‹¤íŒ¨');
                console.error('WBS ë°ì´í„° ì²˜ë¦¬ ì˜¤ë¥˜:', error);
            }
        }

        // í•™ìƒ ë°ì´í„° ì²˜ë¦¬
        function processStudentData(jsonData) {
            try {
                // í—¤ë” í–‰ ì°¾ê¸°
                let headerRowIndex = -1;
                const requiredColumns = ['í•™ë²ˆ', 'ì´ë¦„', 'ê³¼ì •'];
                
                for (let i = 0; i < Math.min(5, jsonData.length); i++) {
                    const row = jsonData[i];
                    if (requiredColumns.every(col => 
                        row.some(cell => cell && cell.toString().includes(col))
                    )) {
                        headerRowIndex = i;
                        break;
                    }
                }
                
                if (headerRowIndex === -1) {
                    showUploadStatus('student', 'error', 'í•™ìƒ ë°ì´í„° í—¤ë”ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                    return;
                }
                
                const headers = jsonData[headerRowIndex];
                const dataRows = jsonData.slice(headerRowIndex + 1);
                
                // ì»¬ëŸ¼ ì¸ë±ìŠ¤ ì°¾ê¸°
                const studentIdIndex = headers.findIndex(h => h && h.toString().includes('í•™ë²ˆ'));
                const nameIndex = headers.findIndex(h => h && h.toString().includes('ì´ë¦„'));
                const positionIndex = headers.findIndex(h => h && h.toString().includes('ê³¼ì •'));
                const semesterIndex = headers.findIndex(h => h && h.toString().includes('í•™ê¸°'));
                const statusIndex = headers.findIndex(h => h && h.toString().includes('í•™ì ìƒíƒœ'));
                const payBasisIndex = headers.findIndex(h => h && h.toString().includes('ì§€ê¸‰ê¸°ì¤€'));
                const monthlyBaseIndex = headers.findIndex(h => h && h.toString().includes('ê¸°ì¤€ê¸ˆì•¡'));
                
                if (studentIdIndex === -1 || nameIndex === -1 || positionIndex === -1) {
                    showUploadStatus('student', 'error', 'í•„ìˆ˜ ì»¬ëŸ¼ì´ ì—†ìŠµë‹ˆë‹¤. (í•™ë²ˆ, ì´ë¦„, ê³¼ì •)');
                    return;
                }
                
                studentDatabase = {};
                dataRows
                    .filter(row => row[studentIdIndex])
                    .forEach(row => {
                        const studentId = row[studentIdIndex] ? row[studentIdIndex].toString() : '';
                        if (studentId) {
                            studentDatabase[studentId] = {
                                name: row[nameIndex] ? row[nameIndex].toString() : '',
                                position: row[positionIndex] ? row[positionIndex].toString() : '',
                                semester: row[semesterIndex] ? row[semesterIndex].toString() : systemSettings.semester,
                                status: row[statusIndex] ? row[statusIndex].toString() : 'ì¬í•™',
                                payBasis: row[payBasisIndex] ? row[payBasisIndex].toString() : 'í•™ìƒì¸ê±´ë¹„',
                                monthlyBase: row[monthlyBaseIndex] ? row[monthlyBaseIndex].toString() : ''
                            };
                        }
                    });
                
                if (Object.keys(studentDatabase).length === 0) {
                    showUploadStatus('student', 'error', 'ìœ íš¨í•œ í•™ìƒ ë°ì´í„°ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                    return;
                }
                
                displayStudentPreview();
                updateStudentDropdown();
                showUploadStatus('student', 'success', `${Object.keys(studentDatabase).length}ëª… í•™ìƒ ë°ì´í„° ë¡œë“œ ì™„ë£Œ`);
                checkAllDataLoaded();
                
            } catch (error) {
                showUploadStatus('student', 'error', 'í•™ìƒ ë°ì´í„° ì²˜ë¦¬ ì‹¤íŒ¨');
                console.error('í•™ìƒ ë°ì´í„° ì²˜ë¦¬ ì˜¤ë¥˜:', error);
            }
        }

        // ëª¨ë“  ë°ì´í„° ë¡œë“œ í™•ì¸
        function checkAllDataLoaded() {
            const academicYear = document.getElementById('academic-year').value;
            const semesterCode = document.getElementById('semester-code').value;
            
            if (wbsData.length > 0 && Object.keys(studentDatabase).length > 0 && academicYear && semesterCode) {
                systemSettings.academicYear = academicYear;
                systemSettings.semester = semesterCode;
                document.getElementById('next-step1').disabled = false;
            }
        }

        // WBS ë¯¸ë¦¬ë³´ê¸° í‘œì‹œ
        function displayWBSPreview() {
            const tbody = document.querySelector('#wbs-table tbody');
            tbody.innerHTML = '';
            
            wbsData.slice(0, 10).forEach(item => {
                const row = tbody.insertRow();
                row.insertCell(0).textContent = item.element;
                row.insertCell(1).textContent = item.accountNo;
                row.insertCell(2).textContent = item.accountName;
            });

            if (wbsData.length > 10) {
                const row = tbody.insertRow();
                const cell = row.insertCell(0);
                cell.colSpan = 3;
                cell.textContent = `... ì™¸ ${wbsData.length - 10}ê°œ í•­ëª©`;
                cell.style.textAlign = 'center';
                cell.style.color = '#718096';
                cell.style.fontStyle = 'italic';
            }

            document.getElementById('wbs-preview').style.display = 'block';
        }

        // í•™ìƒ ë¯¸ë¦¬ë³´ê¸° í‘œì‹œ
        function displayStudentPreview() {
            const tbody = document.querySelector('#student-table tbody');
            tbody.innerHTML = '';
            
            const students = Object.entries(studentDatabase).slice(0, 10);
            students.forEach(([studentId, info]) => {
                const row = tbody.insertRow();
                row.insertCell(0).textContent = studentId;
                row.insertCell(1).textContent = info.name;
                row.insertCell(2).textContent = info.position;
                row.insertCell(3).textContent = info.semester;
                row.insertCell(4).textContent = info.status;
                row.insertCell(5).textContent = info.payBasis;
                row.insertCell(6).textContent = info.monthlyBase;
            });

            if (Object.keys(studentDatabase).length > 10) {
                const row = tbody.insertRow();
                const cell = row.insertCell(0);
                cell.colSpan = 7;
                cell.textContent = `... ì™¸ ${Object.keys(studentDatabase).length - 10}ëª…`;
                cell.style.textAlign = 'center';
                cell.style.color = '#718096';
                cell.style.fontStyle = 'italic';
            }

            document.getElementById('student-preview').style.display = 'block';
        }

        // ë“œë¡­ë‹¤ìš´ ì—…ë°ì´íŠ¸
        function updateWBSDropdown() {
            const select = document.getElementById('wbs-element');
            select.innerHTML = '<option value="">ì„ íƒí•˜ì„¸ìš”</option>';
            
            wbsData.forEach(item => {
                const option = document.createElement('option');
                option.value = item.element;
                option.textContent = `${item.element} (${item.accountName})`;
                select.appendChild(option);
            });
        }

        function updateStudentDropdown() {
            const select = document.getElementById('student-id');
            select.innerHTML = '<option value="">í•™ë²ˆì„ ì„ íƒí•˜ì„¸ìš”</option>';
            
            Object.keys(studentDatabase).forEach(studentId => {
                const option = document.createElement('option');
                option.value = studentId;
                option.textContent = `${studentId} (${studentDatabase[studentId].name})`;
                select.appendChild(option);
            });
        }

        // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì„¤ì •
        function setupEventListeners() {
            // ì‹œìŠ¤í…œ ì„¤ì • ë³€ê²½ ê°ì§€
            document.getElementById('academic-year').addEventListener('change', checkAllDataLoaded);
            document.getElementById('semester-code').addEventListener('change', checkAllDataLoaded);

            // í•™ë²ˆ ì„ íƒì‹œ í•™ìƒ ì •ë³´ ìë™ ì…ë ¥
            document.getElementById('student-id').addEventListener('change', function() {
                const studentId = this.value;
                const studentInfo = studentDatabase[studentId];
                
                if (studentInfo) {
                    document.getElementById('student-name').value = studentInfo.name;
                    document.getElementById('student-position').value = studentInfo.position;
                } else {
                    document.getElementById('student-name').value = '';
                    document.getElementById('student-position').value = '';
                }
            });

            // WBS ì„ íƒì‹œ ê³„ì • ì •ë³´ ìë™ ì…ë ¥
            document.getElementById('wbs-element').addEventListener('change', function() {
                const selectedWBS = this.value;
                const wbsItem = wbsData.find(item => item.element === selectedWBS);
                
                if (wbsItem) {
                    document.getElementById('account-no').value = wbsItem.accountNo;
                    document.getElementById('account-name').value = wbsItem.accountName;
                }
            });

            // í™•ì•½ ê¸°ê°„ ì„ íƒì‹œ ë‚ ì§œ ìë™ ê³„ì‚°
            document.getElementById('start-month').addEventListener('change', updateDates);
            document.getElementById('end-month').addEventListener('change', updateDates);

            // ê¸ˆì•¡ ì…ë ¥ì‹œ í˜•ì‹ ì ìš©
            document.getElementById('monthly-amount').addEventListener('input', formatCurrency);
            document.getElementById('monthly-amount').addEventListener('blur', validateMinimumSalary);
        }

        // í†µí™” í˜•ì‹ ì ìš©
        function formatCurrency(event) {
            let value = event.target.value.replace(/[^0-9]/g, '');
            if (value) {
                value = parseInt(value).toLocaleString();
                event.target.value = value;
            }
        }

        // ìµœì €ê¸°ì¤€ê¸ˆì•¡ ê²€ì¦
        function validateMinimumSalary() {
            const position = document.getElementById('student-position').value;
            const amountStr = document.getElementById('monthly-amount').value;
            const amount = parseInt(amountStr.replace(/[^0-9]/g, ''));
            
            if (position && amount && minimumSalary[position]) {
                if (amount < minimumSalary[position]) {
                    alert(`âš  í•™ìƒì¸ê±´ë¹„ ìµœì €ê¸°ì¤€ê¸ˆì•¡ ë¯¸ë‹¬: í•´ë‹¹ ì›” ì¶”ê°€ ì§€ê¸‰ê³„íšì„ ë°˜ë“œì‹œ ì…ë ¥í•´ ì£¼ì„¸ìš”\n(${position} ê³¼ì • ìµœì €ê¸°ì¤€: ${minimumSalary[position].toLocaleString()}ì›)`);
                }
            }
        }

        // ë‚ ì§œ ì—…ë°ì´íŠ¸
        function updateDates() {
            const startMonth = parseInt(document.getElementById('start-month').value);
            const endMonth = parseInt(document.getElementById('end-month').value);
            
            if (startMonth && endMonth) {
                const year = startMonth <= 2 ? 2026 : 2025;
                const endYear = endMonth <= 2 ? 2026 : 2025;
                
                const startDate = `${year}${startMonth.toString().padStart(2, '0')}01`;
                document.getElementById('start-date').value = startDate;
                
                const endDate = new Date(endYear, endMonth, 0).getDate();
                const endDateStr = `${endYear}${endMonth.toString().padStart(2, '0')}${endDate}`;
                document.getElementById('end-date').value = endDateStr;
            }
        }

        // ë‹¨ê³„ ì´ë™ í•¨ìˆ˜ë“¤
        function goToStep1() {
            document.getElementById('setup-section').style.display = 'block';
            document.getElementById('student-section').style.display = 'none';
            updateStepIndicator(1);
        }

        function goToStep2() {
            document.getElementById('setup-section').style.display = 'none';
            document.getElementById('student-section').style.display = 'block';
            updateStepIndicator(2);
        }

        function goToStep3() {
            document.getElementById('student-section').style.display = 'none';
            document.getElementById('download-section').classList.add('show');
            updateStepIndicator(3);
        }

        // ë‹¨ê³„ í‘œì‹œê¸° ì—…ë°ì´íŠ¸
        function updateStepIndicator(currentStep) {
            document.querySelectorAll('.step').forEach((step, index) => {
                step.classList.remove('active', 'completed');
                if (index + 1 === currentStep) {
                    step.classList.add('active');
                } else if (index + 1 < currentStep) {
                    step.classList.add('completed');
                }
            });
        }

        // í•™ìƒ ì¶”ê°€ (ì¤‘ë³µ ì²´í¬ ë¡œì§ ì œê±°ë¨)
        function addStudent() {
            if (!validateForm()) return;

            const studentData = collectFormData();
            
            // ê¸°ì¡´ì˜ ì¤‘ë³µ ì²´í¬ ë¡œì§ì„ ì œê±°í–ˆìŠµë‹ˆë‹¤.
            // ì´ì œ ë™ì¼í•œ í•™ìƒì´ ê°™ì€ WBSë¡œ ì—¬ëŸ¬ ë²ˆ ë“±ë¡ ê°€ëŠ¥í•©ë‹ˆë‹¤.

            registeredStudents.push(studentData);
            updateStudentsList();
            resetStudentForm();
            
            // ì„±ê³µ ë©”ì‹œì§€
            const successMsg = document.createElement('div');
            successMsg.className = 'alert alert-success';
            successMsg.innerHTML = `<strong>âœ… ì¶”ê°€ ì™„ë£Œ!</strong> ${studentData.studentName}ë‹˜ì´ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤.`;
            
            const form = document.getElementById('student-form');
            form.parentNode.insertBefore(successMsg, form.nextSibling);
            
            setTimeout(() => {
                successMsg.remove();
            }, 3000);
        }

        // í¼ ê²€ì¦
        function validateForm() {
            const form = document.getElementById('student-form');
            const requiredFields = form.querySelectorAll('[required]');
            
            for (let field of requiredFields) {
                if (!field.value.trim()) {
                    field.focus();
                    alert(`${field.previousElementSibling.textContent}ì„(ë¥¼) ì…ë ¥í•´ì£¼ì„¸ìš”.`);
                    return false;
                }
            }
            return true;
        }

        // í¼ ë°ì´í„° ìˆ˜ì§‘
        function collectFormData() {
            const studentId = document.getElementById('student-id').value;
            const studentInfo = studentDatabase[studentId];
            const amountStr = document.getElementById('monthly-amount').value;
            const amount = parseInt(amountStr.replace(/[^0-9]/g, ''));
            
            return {
                studentId: studentId,
                studentName: document.getElementById('student-name').value,
                position: document.getElementById('student-position').value,
                wbsElement: document.getElementById('wbs-element').value,
                accountNo: document.getElementById('account-no').value,
                accountName: document.getElementById('account-name').value,
                role: document.getElementById('role').value,
                projectCategory: document.getElementById('project-category').value,
                monthlyAmount: amount,
                monthlyAmountFormatted: amountStr,
                startMonth: parseInt(document.getElementById('start-month').value),
                endMonth: parseInt(document.getElementById('end-month').value),
                startDate: document.getElementById('start-date').value,
                endDate: document.getElementById('end-date').value,
                semester: studentInfo.semester,
                status: studentInfo.status,
                payBasis: studentInfo.payBasis,
                monthlyBase: studentInfo.monthlyBase
            };
        }

        // ë“±ë¡ëœ í•™ìƒ ëª©ë¡ ì—…ë°ì´íŠ¸
        function updateStudentsList() {
            const container = document.getElementById('students-container');
            const listSection = document.getElementById('students-list');
            
            container.innerHTML = '';
            
            registeredStudents.forEach((student, index) => {
                const studentDiv = document.createElement('div');
                studentDiv.className = 'student-item';
                studentDiv.innerHTML = `
                    <div class="student-info">
                        <strong>${student.studentName} (${student.studentId})</strong> - 
                        ${student.position} - ${student.wbsElement} - ${student.monthlyAmountFormatted}ì›
                        <br><small style="color: #666;">${student.startMonth}ì›”~${student.endMonth}ì›”, ${student.role.substring(0, 30)}...</small>
                    </div>
                    <div class="student-actions">
                        <button class="btn btn-secondary" onclick="editStudent(${index})" style="font-size: 0.8rem; padding: 6px 12px;">ìˆ˜ì •</button>
                        <button class="btn btn-secondary" onclick="removeStudent(${index})" style="font-size: 0.8rem; padding: 6px 12px; background: #fed7d7; border-color: #fc8181; color: #c53030;">ì‚­ì œ</button>
                    </div>
                `;
                container.appendChild(studentDiv);
            });
            
            if (registeredStudents.length > 0) {
                listSection.style.display = 'block';
            } else {
                listSection.style.display = 'none';
            }
        }

        // í•™ìƒ ì •ë³´ ìˆ˜ì •
        function editStudent(index) {
            const student = registeredStudents[index];
            
            // í¼ì— ë°ì´í„° ì±„ìš°ê¸°
            document.getElementById('student-id').value = student.studentId;
            document.getElementById('student-name').value = student.studentName;
            document.getElementById('student-position').value = student.position;
            document.getElementById('wbs-element').value = student.wbsElement;
            document.getElementById('account-no').value = student.accountNo;
            document.getElementById('account-name').value = student.accountName;
            document.getElementById('role').value = student.role;
            document.getElementById('project-category').value = student.projectCategory;
            document.getElementById('monthly-amount').value = student.monthlyAmountFormatted;
            document.getElementById('start-month').value = student.startMonth;
            document.getElementById('end-month').value = student.endMonth;
            document.getElementById('start-date').value = student.startDate;
            document.getElementById('end-date').value = student.endDate;
            
            // í•´ë‹¹ í•™ìƒ ì‚­ì œ (ìˆ˜ì •ì„ ìœ„í•´)
            registeredStudents.splice(index, 1);
            updateStudentsList();
        }

        // í•™ìƒ ì‚­ì œ
        function removeStudent(index) {
            if (confirm('ì •ë§ë¡œ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                registeredStudents.splice(index, 1);
                updateStudentsList();
                updateStudentCount();
            }
        }

        // ì…ë ¥ ì¢…ë£Œ
        function finishInput() {
            if (registeredStudents.length === 0) {
                alert('ë“±ë¡ëœ í•™ìƒì´ ì—†ìŠµë‹ˆë‹¤. ìµœì†Œ 1ëª… ì´ìƒì˜ í•™ìƒì„ ë“±ë¡í•´ì£¼ì„¸ìš”.');
                return;
            }
            
            document.getElementById('generate-section').classList.add('show');
            updateStudentCount();
            
            // í¼ ë¹„í™œì„±í™”
            const form = document.getElementById('student-form');
            const inputs = form.querySelectorAll('input, select, textarea');
            inputs.forEach(input => input.disabled = true);
            
            document.getElementById('add-student-btn').disabled = true;
            document.getElementById('finish-input-btn').disabled = true;
        }

        // í•™ìƒ ìˆ˜ ì—…ë°ì´íŠ¸
        function updateStudentCount() {
            document.getElementById('student-count').textContent = registeredStudents.length;
        }

        // íŒŒì¼ ìƒì„±
        function generateFiles() {
            if (registeredStudents.length === 0) {
                alert('ë“±ë¡ëœ í•™ìƒì´ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }

            setupDownloadButtons();
            goToStep3();
        }

        // ë‹¤ìš´ë¡œë“œ ë²„íŠ¼ ì„¤ì •
        function setupDownloadButtons() {
            document.getElementById('download-salary-btn').onclick = () => generateSalaryFile();
            document.getElementById('download-appointment-btn').onclick = () => generateAppointmentFile();
        }

        // í•™ìƒì¸ê±´ë¹„í™•ì•½ì„œ ìƒì„±
        function generateSalaryFile() {
            const data = [
                ['í•™ë…„ë„', 'í•™ê¸°', 'í•™ë²ˆ', 'ì´ë¦„', 'WBS', 'ê³„ì •ì±…ì„ì ì§ë²ˆ', 'ê³„ì •ì ì´ë¦„', 'í™•ì•½ì„œ ìœ í˜•', 'í™•ì•½ì‹œì‘ì¼', 'í™•ì•½ì¢…ë£Œì¼', 'ì—°êµ¬í™œë™ìœ í˜•', 'í•™ìœ„ë…¼ë¬¸ ì§€ì› ê°œì›”ìˆ˜', 'ì—­í• ', 'ì„ê¸ˆìœ í˜•1', 'ì§€ê¸‰ê¸ˆì•¡1', 'ì„ê¸ˆìœ í˜•2', 'ì§€ê¸‰ê¸ˆì•¡2', 'ì„ê¸ˆìœ í˜•3', 'ì§€ê¸‰ê¸ˆì•¡3', 'ì„ê¸ˆìœ í˜•4', 'ì§€ê¸‰ê¸ˆì•¡4', 'ì„ê¸ˆìœ í˜•5', 'ì§€ê¸‰ê¸ˆì•¡5', 'ì„ê¸ˆìœ í˜•6', 'ì§€ê¸‰ê¸ˆì•¡6', 'ì„ê¸ˆìœ í˜•7', 'ì§€ê¸‰ê¸ˆì•¡7', 'ì„ê¸ˆìœ í˜•8', 'ì§€ê¸‰ê¸ˆì•¡8']
            ];

            registeredStudents.forEach(student => {
                const salaryType = student.position === 'ì„ì‚¬' ? '8031' : '8030';
                data.push([
                    systemSettings.academicYear,
                    systemSettings.semester,
                    student.studentId,
                    student.studentName,
                    student.wbsElement,
                    student.accountNo,
                    student.accountName,
                    '1',
                    student.startDate,
                    student.endDate,
                    '1',
                    '',
                    student.role,
                    salaryType,
                    student.monthlyAmount,
                    '', '', '', '', '', '', '', '', '', '', '', '', '', ''
                ]);
            });

            const ws = XLSX.utils.aoa_to_sheet(data);
            
            // ê¸ˆì•¡ ì»¬ëŸ¼ì— ìˆ«ì í˜•ì‹ ì ìš©
            const range = XLSX.utils.decode_range(ws['!ref']);
            for (let R = 1; R <= range.e.r; R++) {
                const amountCell = XLSX.utils.encode_cell({ r: R, c: 14 });
                if (ws[amountCell]) {
                    ws[amountCell].t = 'n';
                    ws[amountCell].z = '#,##0';
                }
            }

            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'í•™ìƒì¸ê±´ë¹„í™•ì•½ì„œ');
            
            XLSX.writeFile(wb, 'í•™ìƒì¸ê±´ë¹„í™•ì•½ì„œ.xlsx');
        }

        // ëŒ€í•™ì›ìƒì¡°êµì„ìš©ì‹ ì²­ì„œ ìƒì„±
        function generateAppointmentFile() {
            const data = [
                ['No.', 'í•™ë²ˆ(ID)', 'ì´ë¦„(Name)', 'ê³¼ì •(Position)', 'í•™ê¸°(Semester)', 'í•™ì ìƒíƒœ', 'ì§€ê¸‰ê¸°ì¤€', 'ê¸°ì¤€ê¸ˆì•¡(ì›”)', 'ì„ìš©ì‚¬í•­', 'ê³¼ì œêµë‚´ì™¸êµ¬ë¶„', 'ê³¼ì œëŒ€ë¶„ë¥˜', 'ê³¼ì œì†Œë¶„ë¥˜', 'í’€ë§ì—¬ë¶€', 'ì„¸ë¶€ê³¼ì œë²ˆí˜¸', 'ê³„ì •', 'ì—°êµ¬ì±…ì„ìëª…', 'WBS no.', '9ì›”', '10ì›”', '11ì›”', '12ì›”', '1ì›”', '2ì›”', 'ê³„']
            ];

            registeredStudents.forEach((student, index) => {
                const monthlyAmounts = calculateMonthlyAmounts(student);
                
                data.push([
                    index + 1,
                    student.studentId,
                    student.studentName,
                    student.position,
                    student.semester,
                    student.status,
                    student.payBasis,
                    parseInt(student.monthlyBase.replace(/[^0-9]/g, '')) || student.monthlyBase,
                    'ì„ìš©',
                    'êµë‚´',
                    'í•™ìƒì¸ê±´ë¹„_í†µí•©ê³¼ì œ',
                    student.projectCategory,
                    'â—‹',
                    student.wbsElement.substring(0, 12),
                    'í•™ìƒì¸ê±´ë¹„',
                    student.accountName,
                    student.wbsElement,
                    monthlyAmounts.sept || '',
                    monthlyAmounts.oct || '',
                    monthlyAmounts.nov || '',
                    monthlyAmounts.dec || '',
                    monthlyAmounts.jan || '',
                    monthlyAmounts.feb || '',
                    monthlyAmounts.total || ''
                ]);
            });

            const ws = XLSX.utils.aoa_to_sheet(data);
            
            // ê¸ˆì•¡ ì»¬ëŸ¼ë“¤ì— ìˆ«ì í˜•ì‹ ì ìš©
            const range = XLSX.utils.decode_range(ws['!ref']);
            for (let R = 1; R <= range.e.r; R++) {
                // ê¸°ì¤€ê¸ˆì•¡(ì›”) ì»¬ëŸ¼ (Hì—´ - ì¸ë±ìŠ¤ 7)
                const baseAmountCell = XLSX.utils.encode_cell({ r: R, c: 7 });
                if (ws[baseAmountCell] && ws[baseAmountCell].v !== '' && typeof ws[baseAmountCell].v === 'number') {
                    ws[baseAmountCell].t = 'n';
                    ws[baseAmountCell].z = '#,##0';
                }
                
                // 9ì›”~2ì›” ë° ê³„ ì»¬ëŸ¼ë“¤ (R~Xì—´ - ì¸ë±ìŠ¤ 17~23)
                for (let C = 17; C <= 23; C++) {
                    const cell = XLSX.utils.encode_cell({ r: R, c: C });
                    if (ws[cell] && ws[cell].v !== '') {
                        ws[cell].t = 'n';
                        ws[cell].z = '#,##0';
                    }
                }
            }

            const colWidths = [
                {wch: 5}, {wch: 12}, {wch: 12}, {wch: 10}, {wch: 12}, {wch: 10},
                {wch: 12}, {wch: 12}, {wch: 10}, {wch: 10}, {wch: 15}, {wch: 20},
                {wch: 8}, {wch: 15}, {wch: 12}, {wch: 12}, {wch: 20},
                {wch: 10}, {wch: 10}, {wch: 10}, {wch: 10}, {wch: 10}, {wch: 10}, {wch: 12}
            ];
            ws['!cols'] = colWidths;

            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'ëŒ€í•™ì›ìƒì¡°êµì„ìš©ì‹ ì²­ì„œ');
            
            XLSX.writeFile(wb, 'ëŒ€í•™ì›ìƒì¡°êµì„ìš©ì‹ ì²­ì„œ.xlsx');
        }

        // ì›”ë³„ ê¸ˆì•¡ ê³„ì‚°
        function calculateMonthlyAmounts(student) {
            const startMonth = student.startMonth;
            const endMonth = student.endMonth;
            const monthlyAmount = student.monthlyAmount;
            
            const amounts = {
                sept: '', oct: '', nov: '', dec: '', jan: '', feb: '', total: 0
            };

            // í™•ì•½ ê¸°ê°„ ê³„ì‚°
            let currentMonth = startMonth;
            while (true) {
                const actualMonth = currentMonth > 12 ? currentMonth - 12 : currentMonth;
                
                switch (actualMonth) {
                    case 9:
                        amounts.sept = monthlyAmount;
                        amounts.total += monthlyAmount;
                        break;
                    case 10:
                        amounts.oct = monthlyAmount;
                        amounts.total += monthlyAmount;
                        break;
                    case 11:
                        amounts.nov = monthlyAmount;
                        amounts.total += monthlyAmount;
                        break;
                    case 12:
                        amounts.dec = monthlyAmount;
                        amounts.total += monthlyAmount;
                        break;
                    case 1:
                        amounts.jan = monthlyAmount;
                        amounts.total += monthlyAmount;
                        break;
                    case 2:
                        amounts.feb = monthlyAmount;
                        amounts.total += monthlyAmount;
                        break;
                }

                if (actualMonth === endMonth) break;
                currentMonth++;
                if (currentMonth > 24) break; // ë¬´í•œë£¨í”„ ë°©ì§€
            }

            return amounts;
        }

        // í•™ìƒ í¼ ë¦¬ì…‹
        function resetStudentForm() {
            document.getElementById('student-form').reset();
            document.getElementById('student-name').value = '';
            document.getElementById('student-position').value = '';
            document.getElementById('account-no').value = '';
            document.getElementById('account-name').value = '';
            document.getElementById('start-date').value = '';
            document.getElementById('end-date').value = '';
        }

        // ì „ì²´ ë¦¬ì…‹
        function resetAll() {
            // ë°ì´í„° ì´ˆê¸°í™”
            wbsData = [];
            studentDatabase = {};
            registeredStudents = [];
            
            // ì‹œìŠ¤í…œ ì„¤ì • ì´ˆê¸°í™”
            document.getElementById('academic-year').value = '2025';
            document.getElementById('semester-code').value = '0092';
            
            // íŒŒì¼ ì…ë ¥ ì´ˆê¸°í™”
            document.getElementById('wbs-file-input').value = '';
            document.getElementById('student-file-input').value = '';
            
            // ì—…ë¡œë“œ ì˜ì—­ ì´ˆê¸°í™”
            document.getElementById('wbs-upload').classList.remove('completed');
            document.getElementById('student-upload').classList.remove('completed');
            
            // ìƒíƒœ ë©”ì‹œì§€ ìˆ¨ê¸°ê¸°
            document.getElementById('wbs-status').style.display = 'none';
            document.getElementById('student-status').style.display = 'none';
            
            // ë¯¸ë¦¬ë³´ê¸° ìˆ¨ê¸°ê¸°
            document.getElementById('wbs-preview').style.display = 'none';
            document.getElementById('student-preview').style.display = 'none';
            
            // í¼ ë¦¬ì…‹
            resetStudentForm();
            updateStudentsList();
            
            // ì„¹ì…˜ í‘œì‹œ/ìˆ¨ê¸°ê¸°
            document.getElementById('setup-section').style.display = 'block';
            document.getElementById('student-section').style.display = 'none';
            document.getElementById('generate-section').classList.remove('show');
            document.getElementById('download-section').classList.remove('show');
            
            // ë²„íŠ¼ ìƒíƒœ ì´ˆê¸°í™”
            document.getElementById('next-step1').disabled = true;
            
            // í¼ í™œì„±í™”
            const form = document.getElementById('student-form');
            const inputs = form.querySelectorAll('input, select, textarea');
            inputs.forEach(input => input.disabled = false);
            
            document.getElementById('add-student-btn').disabled = false;
            document.getElementById('finish-input-btn').disabled = false;
            
            updateStepIndicator(1);
        }

        // ì—ëŸ¬ ì²˜ë¦¬
        window.addEventListener('error', function(e) {
            console.error('ì˜¤ë¥˜ ë°œìƒ:', e.error);
            alert('ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•˜ê³  ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
        });

        // ë¸Œë¼ìš°ì € í˜¸í™˜ì„± ì²´í¬
        if (!window.XLSX) {
            alert('ì—‘ì…€ ë¼ì´ë¸ŒëŸ¬ë¦¬ ë¡œë”©ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ì¸í„°ë„· ì—°ê²°ì„ í™•ì¸í•˜ê³  í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•´ì£¼ì„¸ìš”.');
        }

    </script>
</body>
</html>